
.cmake_build_windows: &cmake_build_windows
  stage: build
  timeout:  2 hours
  interruptible: true
  before_script:
    - Invoke-Expression -Command .gitlab/ci/config/vcvarsall.ps1
    - "cmake --version"
    - "cmake -V -P .gitlab/ci/config/gitlab_ci_setup.cmake"
    - "ctest -VV -S .gitlab/ci/ctest_configure.cmake"
  script:
    - "ctest -VV -S .gitlab/ci/ctest_build.cmake"
  artifacts:
    expire_in: 24 hours
    when: always
    paths:
      # The artifacts of the build.
      - build/bin/
      - build/include/
      - build/lib/
      - build/vtkm/thirdparty/diy/vtkmdiy/include

      # CTest and CMake install files.
      # XXX(globbing): Can be simplified with support from
      # https://gitlab.com/gitlab-org/gitlab-runner/issues/4840
      #
      # Note: this also captures our CIState.cmake file
      - build/CMakeCache.txt
      - build/*.cmake
      - build/*/*.cmake
      - build/*/*/*.cmake
      - build/*/*/*/*.cmake
      - build/*/*/*/*/*.cmake
      - build/*/*/*/*/*/*.cmake
      - build/Testing/

      # CDash files.
      - build/DartConfiguration.tcl


.cmake_test_windows: &cmake_test_windows
  stage: test
  timeout:  50 minutes
  interruptible: true
  before_script:
    - Invoke-Expression -Command .gitlab/ci/config/vcvarsall.ps1
  script:
    #Need to use our custom ctest-latest symlink
    #This will allow us to use 3.17+ which has support
    #for running failed tests multiple times so failures
    #due to system load are not reported
    - "ctest-latest -VV -S .gitlab/ci/ctest_test.cmake"

.windows_vs2019:
  variables:
    VCVARSALL: "${VS160COMNTOOLS}\\..\\..\\VC\\Auxiliary\\Build\\vcvarsall.bat"
    VCVARSPLATFORM: "x64"
    VCVARSVERSION: "14.25"

# Build on windows10 with Visual Studio
# Will have CUDA 10.2 once build issues are resolved
build:windows_vs2019:
  tags:
    - vtkm # Since this is a bare runner, pin to a project.
    - concurrent
    - build
    - windows
    - shell
    - vs2019
    - msvc-19.25
    - large-memory
  extends:
    - .windows_vs2019
    - .cmake_build_windows
    - .only-default
  variables:
    CMAKE_GENERATOR: "Ninja"
    CMAKE_BUILD_TYPE: Release
    # Disabled while we track down cub allocator issues with vtkm/io tests
    # VTKM_SETTINGS: "cuda+turing"
    VTKM_SETTINGS: "serial"

test:windows_vs2019:
  tags:
    - vtkm # Since this is a bare runner, pin to a project.
    - concurrent
    - test
    - windows
    - shell
    - vs2019
    - msvc-19.25
    - cuda-rt
    - turing
  extends:
    - .windows_vs2019
    - .cmake_test_windows
    - .only-default
  dependencies:
    - build:windows_vs2019
  needs:
    - build:windows_vs2019
